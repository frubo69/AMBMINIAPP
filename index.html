<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>AMBAR</title>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;600;700&family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
:root{
  --gold:#C9A96E;--gold2:#E8C98A;--gold3:#F5E0B0;
  --bg:#07070E;--bg2:#0C0C18;--bg3:#111120;
  --card:#121224;--card2:#161628;
  --border:rgba(201,169,110,.16);--border2:rgba(255,255,255,.06);
  --text:#EDE9E0;--sub:#9896AA;--muted:#54526A;
  --red:#E05555;--green:#4CAF7D;
  --r:16px;--r2:12px;--r3:10px;
  --safe-bottom:env(safe-area-inset-bottom,0px);
}
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent;-webkit-font-smoothing:antialiased}
html,body{background:var(--bg);color:var(--text);font-family:'Outfit',sans-serif;height:100%;overflow:hidden}
button,input{font-family:'Outfit',sans-serif;outline:none}
img{display:block}
.page{position:fixed;inset:0;bottom:calc(60px + var(--safe-bottom));overflow-y:auto;overflow-x:hidden;display:flex;flex-direction:column;opacity:1;transition:opacity .2s,transform .2s}
.page.hidden{opacity:0;pointer-events:none;transform:translateY(8px)}
.hdr{position:sticky;top:0;z-index:40;display:flex;align-items:center;justify-content:space-between;padding:12px 16px;background:rgba(7,7,14,.96);backdrop-filter:blur(20px);border-bottom:1px solid var(--border);flex-shrink:0}
.logo{font-family:'Cormorant Garamond',serif;font-size:22px;font-weight:700;letter-spacing:7px;background:linear-gradient(135deg,var(--gold),var(--gold2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.logo-sub{font-size:7px;letter-spacing:3px;text-transform:uppercase;color:var(--muted);margin-top:-2px}
.hdr-right{display:flex;gap:8px;align-items:center}
.cart-pill{display:flex;align-items:center;gap:6px;background:var(--card2);border:1px solid var(--border);border-radius:50px;padding:7px 13px;position:relative;cursor:pointer;transition:.15s}
.cart-pill:active{transform:scale(.93)}
.cart-txt{font-size:13px;font-weight:600;color:var(--gold2)}
.cart-dot{position:absolute;top:-5px;right:-5px;background:linear-gradient(135deg,var(--gold),var(--gold2));color:#07070E;border-radius:50%;width:18px;height:18px;font-size:9px;font-weight:700;display:none;align-items:center;justify-content:center;border:2px solid var(--bg)}
.lang-btn{width:34px;height:34px;border-radius:50%;border:1px solid var(--border2);background:var(--card2);display:flex;align-items:center;justify-content:center;font-size:15px;cursor:pointer;transition:.15s}
.lang-btn:active{transform:scale(.85)}

/* Active address pill on catalog */
.addr-pill{display:flex;align-items:center;gap:7px;background:var(--bg3);border:1px solid var(--border2);border-radius:50px;padding:6px 12px;cursor:pointer;transition:.15s;max-width:200px}
.addr-pill:active{border-color:var(--gold)}
.addr-pill-txt{font-size:11px;font-weight:500;color:var(--sub);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:140px}
.addr-pill-dot{width:7px;height:7px;border-radius:50%;background:var(--green);flex-shrink:0}

/* Address selector modal */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:200;display:flex;align-items:flex-end;opacity:0;pointer-events:none;transition:opacity .2s}
.modal-overlay.show{opacity:1;pointer-events:all}
.modal-sheet{width:100%;background:var(--bg2);border-radius:20px 20px 0 0;padding:0 0 calc(16px + var(--safe-bottom));max-height:70vh;overflow-y:auto;transform:translateY(60px);transition:transform .25s cubic-bezier(.34,1,.64,1)}
.modal-overlay.show .modal-sheet{transform:translateY(0)}
.modal-handle{width:36px;height:4px;background:var(--border);border-radius:2px;margin:12px auto 16px}
.modal-title{font-family:'Cormorant Garamond',serif;font-size:18px;color:var(--gold2);padding:0 16px 12px;border-bottom:1px solid var(--border2)}
.modal-addr-item{display:flex;align-items:center;gap:12px;padding:13px 16px;border-bottom:1px solid var(--border2);cursor:pointer;transition:.15s}
.modal-addr-item:active{background:rgba(255,255,255,.03)}
.modal-addr-item.active{background:rgba(201,169,110,.06)}
.mai-icon{font-size:22px;flex-shrink:0}
.mai-info{flex:1;min-width:0}
.mai-label{font-size:13px;font-weight:600;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.mai-addr{font-size:11px;color:var(--muted);margin-top:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.mai-check{color:var(--gold);font-size:18px;flex-shrink:0}
.modal-add-btn{display:flex;align-items:center;gap:10px;padding:14px 16px;cursor:pointer;color:var(--gold);font-size:13px;font-weight:600}

.bnav{position:fixed;bottom:0;left:0;right:0;z-index:40;display:flex;background:rgba(7,7,14,.97);border-top:1px solid var(--border);padding-bottom:var(--safe-bottom)}
.nb{flex:1;display:flex;flex-direction:column;align-items:center;padding:9px 4px 7px;gap:3px;border:none;background:transparent;color:var(--muted);cursor:pointer;transition:.15s}
.nb.on{color:var(--gold)}
.nb i{font-size:20px;line-height:1}
.nb span{font-size:9px;letter-spacing:.5px;font-weight:500}

.chips{display:flex;gap:7px;padding:8px 14px 6px;overflow-x:auto;scrollbar-width:none;flex-shrink:0}
.chips::-webkit-scrollbar{display:none}
.chip{white-space:nowrap;padding:7px 14px;border-radius:50px;border:1px solid var(--border2);background:transparent;color:var(--muted);font-size:11px;font-weight:500;cursor:pointer;transition:.15s}
.chip.on{background:rgba(201,169,110,.1);border-color:var(--gold);color:var(--gold);font-weight:700}
.sec-h{padding:10px 14px 8px;font-family:'Cormorant Garamond',serif;font-size:20px;display:flex;align-items:center;gap:10px;flex-shrink:0}
.sec-h::after{content:'';flex:1;height:1px;background:linear-gradient(90deg,var(--border2),transparent)}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;padding:2px 12px 16px}
@media(min-width:460px){.grid{grid-template-columns:repeat(3,1fr)}}
.pcard{background:var(--card);border:1px solid var(--border2);border-radius:var(--r);overflow:hidden;display:flex;flex-direction:column;transition:.15s}
.pcard:active{transform:scale(.97)}
.pimg-box{height:148px;background:linear-gradient(155deg,#0E0E1E,#090916);display:flex;align-items:center;justify-content:center;padding:10px;position:relative;overflow:hidden}
.pimg{max-height:128px;max-width:90%;object-fit:contain;filter:drop-shadow(0 6px 20px rgba(0,0,0,.7))}
.pbadge{position:absolute;font-size:8px;letter-spacing:1px;text-transform:uppercase;padding:3px 7px;border-radius:6px;font-weight:700}
.pbadge.oos{left:8px;top:8px;background:rgba(0,0,0,.7);border:1px solid var(--border2);color:var(--muted)}
.pbadge.isnew{right:8px;top:8px;background:linear-gradient(135deg,var(--gold),var(--gold2));color:#07070E}
.pinfo{padding:10px 11px 12px;flex:1;display:flex;flex-direction:column;gap:4px}
.pcat{font-size:8px;letter-spacing:2px;text-transform:uppercase;color:var(--gold);font-weight:600}
.pname{font-family:'Cormorant Garamond',serif;font-size:15px;font-weight:600;line-height:1.2}
.pdesc{font-size:10px;color:var(--muted);line-height:1.45;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
.pfoot{display:flex;align-items:center;justify-content:space-between;margin-top:auto;padding-top:8px}
.pprice{font-size:16px;font-weight:700;color:var(--gold2)}
.pprice small{font-size:9px;color:var(--muted);font-weight:400}
.add-btn{width:32px;height:32px;border-radius:9px;background:linear-gradient(135deg,var(--gold),var(--gold2));border:none;color:#07070E;font-size:22px;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:.13s}
.add-btn:active{transform:scale(.75)}
.add-btn:disabled{background:var(--card2);color:var(--muted);cursor:not-allowed}
.qctrl{display:flex;align-items:center;gap:5px}
.qb{width:28px;height:28px;border-radius:8px;border:1px solid var(--border);background:var(--bg3);color:var(--gold);font-size:18px;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:.12s}
.qb:active{transform:scale(.75)}
.qn{font-size:13px;font-weight:700;min-width:20px;text-align:center;color:var(--gold2)}
.empty{text-align:center;padding:60px 20px;color:var(--muted)}
.empty-icon{font-size:54px;margin-bottom:14px;opacity:.3}
.ci{display:flex;align-items:center;gap:11px;padding:13px 16px;border-bottom:1px solid var(--border2)}
.ci-img{width:50px;height:60px;object-fit:contain;background:var(--card);border-radius:10px;padding:5px;flex-shrink:0}
.ci-info{flex:1;min-width:0}
.ci-name{font-size:13px;font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.ci-price{font-size:12px;color:var(--gold);font-weight:600;margin-top:2px}
.tip-wrap{padding:14px 16px;border-top:1px solid var(--border2)}
.tip-label{font-size:9px;letter-spacing:2.5px;text-transform:uppercase;color:var(--muted);font-weight:600;margin-bottom:10px}
.tip-row{display:flex;flex-wrap:wrap;gap:7px}
.tip-chip{padding:8px 14px;border-radius:50px;border:1px solid var(--border2);background:transparent;color:var(--sub);font-size:12px;font-weight:500;cursor:pointer;transition:.15s}
.tip-chip.on{background:rgba(201,169,110,.1);border-color:var(--gold);color:var(--gold);font-weight:700}
.tip-input{width:100%;margin-top:10px;background:var(--bg3);border:1.5px solid var(--border2);border-radius:var(--r3);padding:11px 14px;color:var(--text);font-size:14px;display:none;transition:.2s}
.tip-input:focus{border-color:var(--gold)}
.cart-foot{padding:14px 16px;background:var(--bg2);border-top:1px solid var(--border)}
.total-row{display:flex;justify-content:space-between;align-items:baseline;margin-bottom:12px}
.total-lbl{font-size:9px;letter-spacing:2.5px;text-transform:uppercase;color:var(--muted);font-weight:600}
.total-val{font-family:'Cormorant Garamond',serif;font-size:28px;color:var(--gold2);font-weight:600}
.btn-main{width:100%;background:linear-gradient(135deg,var(--gold),var(--gold2),var(--gold3));color:#07070E;border:none;border-radius:14px;padding:15px;font-size:15px;font-weight:700;cursor:pointer;letter-spacing:.3px;transition:.15s}
.btn-main:active{transform:scale(.98);opacity:.9}
.btn-main:disabled{opacity:.3;cursor:not-allowed}
.btn-outline{width:100%;background:transparent;border:1.5px solid var(--border);color:var(--sub);border-radius:14px;padding:13px;font-size:14px;font-weight:500;cursor:pointer;margin-top:8px;transition:.15s}
.btn-outline:active{border-color:var(--gold);color:var(--gold)}

/* Cart active address banner */
.cart-addr-bar{margin:12px 16px 0;background:var(--card);border:1px solid var(--border2);border-radius:var(--r2);padding:11px 14px;display:flex;align-items:center;gap:10px;cursor:pointer}
.cart-addr-bar:active{border-color:var(--gold)}
.cab-icon{font-size:18px;flex-shrink:0}
.cab-info{flex:1;min-width:0}
.cab-label{font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:1px;font-weight:600}
.cab-addr{font-size:13px;font-weight:600;color:var(--text);margin-top:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.cab-change{font-size:11px;color:var(--gold);font-weight:600;flex-shrink:0}

/* ADDRESS PAGE */
.addr-page-body{padding:14px 16px}
.addr-form-card{background:var(--card);border:1px solid var(--border2);border-radius:var(--r);overflow:hidden;margin-bottom:14px}
.addr-form-head{padding:13px 15px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--border2)}
.addr-form-title{font-size:14px;font-weight:600}
.addr-form-body{padding:14px 15px}
.flabel{display:block;font-size:9px;letter-spacing:2.5px;text-transform:uppercase;color:var(--muted);margin-bottom:7px;font-weight:600}
.finput{width:100%;background:var(--bg3);border:1.5px solid var(--border2);border-radius:var(--r3);padding:12px 14px;color:var(--text);font-size:14px;transition:.2s}
.finput:focus{border-color:var(--gold);box-shadow:0 0 0 3px rgba(201,169,110,.07)}
.finput::placeholder{color:var(--muted)}
.finput.err{border-color:var(--red)!important}
.ferr{font-size:11px;color:var(--red);margin-top:6px;display:none}
.ferr.on{display:block}

/* Method tabs */
.mtabs{display:flex;gap:8px;margin-bottom:14px}
.mtab{flex:1;padding:10px 6px;background:var(--bg3);border:1.5px solid var(--border2);border-radius:var(--r2);cursor:pointer;color:var(--muted);font-size:11px;font-weight:600;text-align:center;display:flex;flex-direction:column;align-items:center;gap:4px;transition:.15s}
.mtab i{font-size:20px}
.mtab.on{border-color:var(--gold);background:rgba(201,169,110,.08);color:var(--gold)}
.mtab:active{transform:scale(.95)}
.mpanel{display:none}
.mpanel.show{display:block}
.gps-btn{display:flex;align-items:center;gap:10px;width:100%;background:rgba(201,169,110,.07);border:1.5px solid rgba(201,169,110,.25);border-radius:var(--r2);padding:14px 15px;cursor:pointer;color:var(--gold);font-size:13px;font-weight:600;transition:.2s;margin-bottom:10px}
.gps-btn:active{transform:scale(.97)}
.gps-status{font-size:12px;padding:9px 12px;border-radius:9px;display:none;margin-bottom:10px}
.gps-status.ok{display:block;background:rgba(76,175,125,.1);color:var(--green);border:1px solid rgba(76,175,125,.2)}
.gps-status.fail{display:block;background:rgba(224,85,85,.08);color:var(--red);border:1px solid rgba(224,85,85,.18)}
.type-chips{display:flex;gap:7px;flex-wrap:wrap;margin-bottom:12px}
.type-chip{padding:8px 13px;border-radius:50px;border:1px solid var(--border2);background:transparent;color:var(--sub);font-size:12px;cursor:pointer;transition:.15s}
.type-chip.on{background:rgba(201,169,110,.1);border-color:var(--gold);color:var(--gold);font-weight:600}
.frow{display:flex;gap:8px;margin-bottom:10px}
.frow>div{flex:1;min-width:0}
.opill{font-size:11px;font-weight:600;color:var(--gold);background:rgba(201,169,110,.08);border:1px solid rgba(201,169,110,.2);padding:8px 12px;border-radius:8px;margin-top:10px;display:none}
.opill.on{display:block}

/* Saved addr cards */
.saved-card{background:var(--card);border:1px solid var(--border2);border-radius:var(--r2);padding:13px 14px;margin-bottom:10px;display:flex;align-items:center;gap:10px;position:relative}
.saved-card.active-addr{border-color:var(--gold);background:rgba(201,169,110,.04)}
.sc-icon{font-size:22px;flex-shrink:0}
.sc-info{flex:1;min-width:0}
.sc-label{font-size:13px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.sc-addr{font-size:11px;color:var(--muted);margin-top:3px;line-height:1.4;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.sc-office{font-size:10px;color:var(--gold);margin-top:3px}
.sc-actions{display:flex;gap:6px;flex-shrink:0}
.sc-btn{width:30px;height:30px;border-radius:8px;border:1px solid var(--border2);background:var(--bg3);display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:13px;transition:.15s}
.sc-btn:active{transform:scale(.85)}
.sc-btn.del{border-color:rgba(224,85,85,.3);background:rgba(224,85,85,.08);color:var(--red)}
.sc-btn.sel{border-color:rgba(201,169,110,.3);background:rgba(201,169,110,.08);color:var(--gold)}
.active-badge{position:absolute;top:-6px;right:10px;font-size:8px;font-weight:700;letter-spacing:1px;padding:2px 7px;border-radius:50px;background:var(--gold);color:#07070E}

/* Confirm modal */
.confirm-overlay{position:fixed;inset:0;background:rgba(0,0,0,.75);z-index:300;display:flex;align-items:center;justify-content:center;padding:24px;opacity:0;pointer-events:none;transition:opacity .2s}
.confirm-overlay.show{opacity:1;pointer-events:all}
.confirm-box{background:var(--card2);border:1px solid var(--border);border-radius:var(--r);padding:24px;width:100%;max-width:320px}
.confirm-icon{font-size:36px;text-align:center;margin-bottom:12px}
.confirm-title{font-family:'Cormorant Garamond',serif;font-size:18px;color:var(--gold2);text-align:center;margin-bottom:8px}
.confirm-msg{font-size:13px;color:var(--sub);text-align:center;line-height:1.5;margin-bottom:20px}
.confirm-btns{display:flex;gap:10px}
.confirm-btns button{flex:1;padding:12px;border-radius:var(--r3);border:none;font-size:13px;font-weight:700;cursor:pointer;transition:.15s}
.confirm-yes{background:linear-gradient(135deg,var(--gold),var(--gold2));color:#07070E}
.confirm-no{background:var(--bg3);border:1px solid var(--border)!important;color:var(--sub)}

/* Orders */
.co-body{padding:14px 16px}
.co-card{background:var(--card);border:1px solid var(--border2);border-radius:var(--r);margin-bottom:12px;overflow:hidden}
.co-head{padding:13px 15px;display:flex;align-items:center;gap:10px;border-bottom:1px solid var(--border2)}
.co-num{width:26px;height:26px;border-radius:50%;background:linear-gradient(135deg,var(--gold),var(--gold2));color:#07070E;font-size:12px;font-weight:700;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.co-title{font-size:14px;font-weight:600}
.co-inner{padding:14px 15px}
.sum-card{background:var(--card);border:1px solid var(--border);border-radius:var(--r);padding:14px 16px;margin:0 16px 14px}
.sum-title{font-family:'Cormorant Garamond',serif;font-size:17px;color:var(--gold2);margin-bottom:10px}
.sum-line{display:flex;justify-content:space-between;font-size:12px;color:var(--sub);margin-bottom:5px}
.sum-div{height:1px;background:var(--border2);margin:8px 0}
.sum-total{display:flex;justify-content:space-between;font-size:15px;font-weight:700;color:var(--gold2)}
.co-foot{padding:0 16px 16px}
.ocard{background:var(--card);border:1px solid var(--border2);border-radius:var(--r);padding:14px;margin:0 14px 10px}
.ocard-top{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:8px}
.o-id{font-size:12px;font-weight:700;color:var(--gold2)}
.o-date{font-size:10px;color:var(--muted);margin-top:2px}
.o-status{font-size:10px;font-weight:600;padding:4px 10px;border-radius:50px}
.sp{background:rgba(201,169,110,.1);color:var(--gold);border:1px solid rgba(201,169,110,.2)}
.sc2{background:rgba(76,175,125,.1);color:var(--green);border:1px solid rgba(76,175,125,.2)}
.sd{background:rgba(76,175,125,.15);color:var(--green);border:1px solid rgba(76,175,125,.25)}
.sx{background:rgba(224,85,85,.1);color:var(--red);border:1px solid rgba(224,85,85,.2)}
.o-items{font-size:12px;color:var(--sub);line-height:1.75;border-top:1px solid var(--border2);padding-top:8px;margin-top:4px}
.o-total{font-size:14px;font-weight:700;color:var(--gold2);margin-top:6px}
.profile-card{background:var(--card);border:1px solid var(--border2);border-radius:var(--r);padding:20px;margin:14px}
.profile-avatar{width:64px;height:64px;border-radius:50%;background:linear-gradient(135deg,var(--gold),var(--gold2));display:flex;align-items:center;justify-content:center;font-size:28px;margin:0 auto 12px;font-family:'Cormorant Garamond',serif;color:#07070E;font-weight:700}
.profile-name{text-align:center;font-family:'Cormorant Garamond',serif;font-size:20px;color:var(--gold2)}
.profile-stat{display:flex;border-top:1px solid var(--border2);margin-top:14px}
.ps{flex:1;text-align:center;padding:12px 6px;border-right:1px solid var(--border2)}
.ps:last-child{border-right:none}
.ps-n{font-size:20px;font-weight:700;color:var(--gold2)}
.ps-l{font-size:9px;letter-spacing:1px;text-transform:uppercase;color:var(--muted);margin-top:2px}
/* Toast */
.toast{position:fixed;bottom:calc(70px + var(--safe-bottom));left:50%;transform:translateX(-50%);background:var(--card2);border:1px solid var(--border);color:var(--text);padding:10px 20px;border-radius:50px;font-size:12px;white-space:nowrap;z-index:500;pointer-events:none;box-shadow:0 8px 28px rgba(0,0,0,.55);opacity:0;visibility:hidden;transition:opacity .22s,visibility .22s}
.toast.show{opacity:1;visibility:visible}
.toast.ok{border-color:var(--green);color:#90e8b8}
.toast.err{border-color:var(--red);color:#f0a0a0}
</style>
</head>
<body>

<!-- â•â•â• CATALOG â•â•â• -->
<div id="pg-catalog" class="page">
  <div class="hdr">
    <div><div class="logo">AMBAR</div><div class="logo-sub">Premium Spirits</div></div>
    <div class="hdr-right">
      <div class="cart-pill" onclick="go('cart')">ğŸ›’ <span class="cart-txt" id="hdr-tot">0 AED</span><span class="cart-dot" id="hdr-dot">0</span></div>
      <button class="lang-btn" onclick="flipLang()" id="lbtn">ğŸ‡·ğŸ‡º</button>
    </div>
  </div>
  <!-- Active address selector -->
  <div style="padding:8px 14px 0">
    <div class="addr-pill" onclick="openAddrModal()" id="addr-pill">
      <span class="addr-pill-dot" id="addr-pill-dot" style="background:var(--muted)"></span>
      <span class="addr-pill-txt" id="addr-pill-txt">Ğ”Ğ¾Ğ±Ğ°Ğ²ÑŒÑ‚Ğµ Ğ°Ğ´Ñ€ĞµÑ Ğ´Ğ¾ÑÑ‚Ğ°Ğ²ĞºĞ¸</span>
    </div>
  </div>
  <div class="chips" id="cat-chips"></div>
  <div class="sec-h" id="sh-catalog">ĞšĞ°Ñ‚Ğ°Ğ»Ğ¾Ğ³</div>
  <div class="grid" id="p-grid"></div>
</div>

<!-- â•â•â• CART â•â•â• -->
<div id="pg-cart" class="page hidden">
  <div class="hdr">
    <div><div class="logo">AMBAR</div><div class="logo-sub" id="ls-cart">ĞšĞ¾Ñ€Ğ·Ğ¸Ğ½Ğ°</div></div>
    <div class="hdr-right"><button class="lang-btn" onclick="flipLang()">ğŸ‡·ğŸ‡º</button></div>
  </div>
  <!-- Active addr banner -->
  <div class="cart-addr-bar" onclick="openAddrModal()" id="cab">
    <span class="cab-icon">ğŸ“</span>
    <div class="cab-info">
      <div class="cab-label" id="cab-label">ĞĞ”Ğ Ğ•Ğ¡ Ğ”ĞĞ¡Ğ¢ĞĞ’ĞšĞ˜</div>
      <div class="cab-addr" id="cab-addr">ĞĞµ Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½ â€” Ğ½Ğ°Ğ¶Ğ¼Ğ¸Ñ‚Ğµ Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ</div>
    </div>
    <span class="cab-change" id="cab-change">Ğ˜Ğ·Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ</span>
  </div>
  <div id="cart-list"></div>
  <div id="tip-section" style="display:none">
    <div class="tip-wrap">
      <div class="tip-label" id="tip-lbl">Ğ§ĞĞ•Ğ’Ğ«Ğ•</div>
      <div class="tip-row" id="tip-row"></div>
      <input class="tip-input" id="tip-input" type="number" min="0">
    </div>
  </div>
  <div id="cart-foot" style="display:none">
    <div class="cart-foot">
      <div class="total-row"><span class="total-lbl" id="tot-lbl">Ğ˜Ğ¢ĞĞ“Ğ</span><span class="total-val"><span id="tot-n">0</span> AED</span></div>
      <button class="btn-main" id="co-btn" onclick="tryOrder()">ĞÑ„Ğ¾Ñ€Ğ¼Ğ¸Ñ‚ÑŒ Ğ·Ğ°ĞºĞ°Ğ· â†’</button>
      <button class="btn-outline" id="clear-btn" onclick="clearCart()">ğŸ—‘ ĞÑ‡Ğ¸ÑÑ‚Ğ¸Ñ‚ÑŒ ĞºĞ¾Ñ€Ğ·Ğ¸Ğ½Ñƒ</button>
    </div>
  </div>
</div>

<!-- â•â•â• ADDRESS PAGE â•â•â• -->
<div id="pg-address" class="page hidden">
  <div class="hdr">
    <div><div class="logo">AMBAR</div><div class="logo-sub" id="ls-addr">ĞĞ´Ñ€ĞµÑĞ°</div></div>
    <div class="hdr-right"><button class="lang-btn" onclick="flipLang()">ğŸ‡·ğŸ‡º</button></div>
  </div>
  <div class="addr-page-body">
    <!-- Saved addresses list -->
    <div class="sec-h" id="sh-saved-addr">Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ñ‘Ğ½Ğ½Ñ‹Ğµ Ğ°Ğ´Ñ€ĞµÑĞ°</div>
    <div id="saved-cards"></div>

    <!-- Add new address form -->
    <div class="addr-form-card">
      <div class="addr-form-head">
        <span class="addr-form-title" id="add-form-title">â• Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ°Ğ´Ñ€ĞµÑ</span>
      </div>
      <div class="addr-form-body">
        <!-- Method tabs -->
        <div class="mtabs">
          <button class="mtab on" id="mtab-gps" onclick="switchMethod('gps')"><i>ğŸ“</i><span id="mtl-gps">GPS</span></button>
          <button class="mtab" id="mtab-manual" onclick="switchMethod('manual')"><i>âœï¸</i><span id="mtl-manual">Ğ’Ñ€ÑƒÑ‡Ğ½ÑƒÑ</span></button>
        </div>

        <!-- GPS panel -->
        <div class="mpanel show" id="mpanel-gps">
          <button class="gps-btn" onclick="grabGPS()" id="gps-btn"><span style="font-size:22px">ğŸ“</span><span id="gps-lbl">ĞŸĞ¾Ğ´ĞµĞ»Ğ¸Ñ‚ÑŒÑÑ Ğ³ĞµĞ¾Ğ»Ğ¾ĞºĞ°Ñ†Ğ¸ĞµĞ¹</span></button>
          <div class="gps-status" id="gps-status"></div>
        </div>
        </div>

        <!-- Manual panel -->
        <div class="mpanel" id="mpanel-manual">
          <label class="flabel" id="lbl-area">Ğ ĞĞ™ĞĞ / Ğ—ĞĞĞ</label>
          <div class="type-chips" id="area-chips" style="margin-bottom:12px"></div>
          <label class="flabel" id="lbl-street">Ğ£Ğ›Ğ˜Ğ¦Ğ / Ğ—Ğ”ĞĞĞ˜Ğ•</label>
          <input class="finput" id="man-street" type="text" style="margin-bottom:12px" placeholder="JVC Bloom Tower / Jumeirah St">
</div>

        <div class="opill" id="opill"></div>
        <div class="ferr" id="addr-form-err"></div>

        <!-- Name label -->
        <label class="flabel" style="margin-top:14px" id="lbl-addr-name">ĞĞĞ—Ğ’ĞĞĞ˜Ğ• ĞĞ”Ğ Ğ•Ğ¡Ğ</label>
        <input class="finput" id="addr-name-in" type="text" placeholder="Ğ”Ğ¾Ğ¼ / ĞÑ„Ğ¸Ñ / JVC...">

        <label class="flabel" style="margin-top:14px" id="lbl-addr-comment">ĞšĞĞœĞœĞ•ĞĞ¢ĞĞ Ğ˜Ğ™ Ğ”Ğ›Ğ¯ ĞšĞ£Ğ Ğ¬Ğ•Ğ Ğ</label>
        <textarea class="finput" id="addr-comment-in" rows="3" placeholder="Ğ”Ğ¾Ğ¼Ğ¾Ñ„Ğ¾Ğ½ 47, 3 ÑÑ‚Ğ°Ğ¶, ĞºĞ²Ğ°Ñ€Ñ‚Ğ¸Ñ€Ğ° ÑĞ¿Ñ€Ğ°Ğ²Ğ°..." style="resize:none;height:76px;padding-top:10px"></textarea>

        <button class="btn-main" style="margin-top:14px" onclick="saveNewAddress()" id="save-addr-btn">ğŸ’¾ Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ Ğ°Ğ´Ñ€ĞµÑ</button>
      </div>
    </div>
  </div>
</div>

<!-- â•â•â• ORDERS â•â•â• -->
<div id="pg-orders" class="page hidden">
  <div class="hdr">
    <div><div class="logo">AMBAR</div><div class="logo-sub" id="ls-ord">Ğ˜ÑÑ‚Ğ¾Ñ€Ğ¸Ñ</div></div>
    <div class="hdr-right"><button class="lang-btn" onclick="flipLang()">ğŸ‡·ğŸ‡º</button></div>
  </div>
  <div class="sec-h" id="sh-orders">ĞœĞ¾Ğ¸ Ğ·Ğ°ĞºĞ°Ğ·Ñ‹</div>
  <div id="orders-list"></div>
</div>

<!-- â•â•â• PROFILE â•â•â• -->
<div id="pg-profile" class="page hidden">
  <div class="hdr">
    <div><div class="logo">AMBAR</div><div class="logo-sub" id="ls-prof">ĞŸÑ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ</div></div>
    <div class="hdr-right"><button class="lang-btn" onclick="flipLang()">ğŸ‡·ğŸ‡º</button></div>
  </div>
  <div class="profile-card">
    <div class="profile-avatar" id="prof-av">A</div>
    <div class="profile-name" id="prof-name">â€”</div>
    <div class="profile-stat">
      <div class="ps"><div class="ps-n" id="stat-total">0</div><div class="ps-l" id="stat-lbl1">Ğ—ĞĞšĞĞ—ĞĞ’</div></div>
      <div class="ps"><div class="ps-n" id="stat-active">0</div><div class="ps-l" id="stat-lbl2">ĞĞšĞ¢Ğ˜Ğ’ĞĞ«Ğ¥</div></div>
      <div class="ps"><div class="ps-n" id="stat-spent">0</div><div class="ps-l" id="stat-lbl3">AED</div></div>
    </div>
  </div>
  <div style="padding:0 14px 14px">
    <div class="sec-h" id="sh-active">ĞĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ğµ Ğ·Ğ°ĞºĞ°Ğ·Ñ‹</div>
    <div id="active-list"></div>
  </div>
</div>

<!-- CHECKOUT (hidden, used by placeOrder) -->
<div id="pg-checkout" class="page hidden">
  <div class="hdr">
    <div><div class="logo">AMBAR</div><div class="logo-sub" id="ls-co">ĞÑ„Ğ¾Ñ€Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ</div></div>
    <div class="hdr-right"><button class="lang-btn" onclick="flipLang()">ğŸ‡·ğŸ‡º</button></div>
  </div>
  <div class="co-body">
    <div class="co-card">
      <div class="co-head"><div class="co-num">1</div><div class="co-title" id="co-addr-title">ĞĞ´Ñ€ĞµÑ Ğ´Ğ¾ÑÑ‚Ğ°Ğ²ĞºĞ¸</div></div>
      <div class="co-inner" id="co-addr-preview" style="font-size:13px;color:var(--sub);line-height:1.6"></div>
    </div>
    <div class="co-card">
      <div class="co-head"><div class="co-num">2</div><div class="co-title" id="ct2">ĞĞ¾Ğ¼ĞµÑ€ Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½Ğ°</div></div>
      <div class="co-inner">
        <label class="flabel" id="phone-lbl">Ğ¢ĞĞ›Ğ¬ĞšĞ Ğ¦Ğ˜Ğ¤Ğ Ğ«, 10â€“15 Ğ—ĞĞĞšĞĞ’</label>
        <input class="finput" id="phone-in" type="tel" inputmode="numeric" placeholder="971501234567" oninput="this.classList.remove('err');el('phone-err').classList.remove('on')">
        <div class="ferr" id="phone-err"></div>
      </div>
    </div>
  </div>
  <div class="sum-card">
    <div class="sum-title" id="sum-title">Ğ’Ğ°Ñˆ Ğ·Ğ°ĞºĞ°Ğ·</div>
    <div id="sum-items"></div>
    <div class="sum-div"></div>
    <div class="sum-line" id="sum-tip-row" style="display:none"><span id="sum-tip-lbl">Ğ§Ğ°ĞµĞ²Ñ‹Ğµ</span><span id="sum-tip-val">0 AED</span></div>
    <div class="sum-total"><span id="sum-tot-lbl">Ğ˜Ñ‚Ğ¾Ğ³Ğ¾</span><span id="sum-tot-val">0 AED</span></div>
  </div>
  <div class="co-foot"><button class="btn-main" id="place-btn" onclick="placeOrder()">âœ… ĞŸĞ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ´Ğ¸Ñ‚ÑŒ Ğ·Ğ°ĞºĞ°Ğ·</button></div>
</div>

<!-- NAV -->
<div class="bnav">
  <button class="nb on" id="nb-catalog" onclick="go('catalog')"><i>ğŸ¾</i><span id="nbl-cat">ĞšĞ°Ñ‚Ğ°Ğ»Ğ¾Ğ³</span></button>
  <button class="nb" id="nb-cart" onclick="go('cart')"><i>ğŸ›’</i><span id="nbl-cart">ĞšĞ¾Ñ€Ğ·Ğ¸Ğ½Ğ°</span></button>
  <button class="nb" id="nb-address" onclick="go('address')"><i>ğŸ“</i><span id="nbl-addr">ĞĞ´Ñ€ĞµÑĞ°</span></button>
  <button class="nb" id="nb-orders" onclick="go('orders')"><i>ğŸ“¦</i><span id="nbl-ord">Ğ˜ÑÑ‚Ğ¾Ñ€Ğ¸Ñ</span></button>
  <button class="nb" id="nb-profile" onclick="go('profile');buildProfile()"><i>ğŸ‘¤</i><span id="nbl-prof">ĞŸÑ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ</span></button>
</div>

<!-- Address selector modal -->
<div class="modal-overlay" id="addr-modal" onclick="closeAddrModal(event)">
  <div class="modal-sheet">
    <div class="modal-handle"></div>
    <div class="modal-title" id="modal-title">ĞĞ´Ñ€ĞµÑ Ğ´Ğ¾ÑÑ‚Ğ°Ğ²ĞºĞ¸</div>
    <div id="modal-addr-list"></div>
    <div class="modal-add-btn" onclick="closeAddrModal();go('address')">
      <span style="font-size:20px">â•</span><span id="modal-add-lbl">Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ Ğ°Ğ´Ñ€ĞµÑ</span>
    </div>
  </div>
</div>

<!-- Location mismatch confirm -->
<div class="confirm-overlay" id="loc-confirm">
  <div class="confirm-box">
    <div class="confirm-icon">ğŸ“</div>
    <div class="confirm-title" id="lc-title">Ğ’Ñ‹ Ñ‚Ğ°Ğ¼?</div>
    <div class="confirm-msg" id="lc-msg">ĞŸĞ¾Ñ…Ğ¾Ğ¶Ğµ, Ğ²Ñ‹ Ğ½Ğ°Ñ…Ğ¾Ğ´Ğ¸Ñ‚ĞµÑÑŒ Ğ´Ğ°Ğ»ĞµĞºĞ¾ Ğ¾Ñ‚ Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ½Ğ¾Ğ³Ğ¾ Ğ°Ğ´Ñ€ĞµÑĞ°. ĞÑ„Ğ¾Ñ€Ğ¼Ğ¸Ñ‚ÑŒ Ğ·Ğ°ĞºĞ°Ğ· Ñ‚ÑƒĞ´Ğ°?</div>
    <div class="confirm-btns">
      <button class="confirm-yes" onclick="confirmLocYes()" id="lc-yes">Ğ”Ğ°, Ğ·Ğ°ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ</button>
      <button class="confirm-no" onclick="confirmLocNo()" id="lc-no">ĞÑ‚Ğ¼ĞµĞ½Ğ°</button>
    </div>
  </div>
</div>

<!-- Toasts (two elements to avoid stuck animation) -->
<div class="toast" id="toast0"></div>
<div class="toast" id="toast1"></div>

<script>
// â”€â”€ OFFICES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const OFFICES=[
  {id:'office_central',name:'Ambar Central',lat:25.0969,lon:55.1587},
  {id:'office_north',  name:'Ambar North',  lat:25.0474,lon:55.2386},
];
const AREAS={
  ru:[
    {lbl:'Ğ¦ĞµĞ½Ñ‚Ñ€ / Downtown',   office:'office_central'},
    {lbl:'Ğ”ĞµĞ¹Ñ€Ğ° / Ğ‘ÑƒÑ€-Ğ”ÑƒĞ±Ğ°Ğ¹', office:'office_central'},
    {lbl:'ĞœĞ°Ñ€Ğ¸Ğ½Ğ° / JBR',       office:'office_north'},
    {lbl:'JLT / Jumeirah',     office:'office_north'},
    {lbl:'Ğ‘Ğ¸Ğ·Ğ½ĞµÑ Ğ‘ÑĞ¹',         office:'office_central'},
    {lbl:'JVC / JVT',          office:'office_north'},
    {lbl:'Ğ”Ñ€ÑƒĞ³Ğ¾Ğ¹ Ñ€Ğ°Ğ¹Ğ¾Ğ½',       office:'office_central'},
  ],
  en:[
    {lbl:'Downtown / DIFC',   office:'office_central'},
    {lbl:'Deira / Bur Dubai', office:'office_central'},
    {lbl:'Marina / JBR',      office:'office_north'},
    {lbl:'JLT / Jumeirah',    office:'office_north'},
    {lbl:'Business Bay',      office:'office_central'},
    {lbl:'JVC / JVT',         office:'office_north'},
    {lbl:'Other area',        office:'office_central'},
  ],
};
const TYPES={
  ru:[
    {id:'home',  icon:'ğŸ ',lbl:'Ğ”Ğ¾Ğ¼ / Ğ’Ğ¸Ğ»Ğ»Ğ°',fields:[
      {k:'villa',   l:'Ğ’Ğ˜Ğ›Ğ›Ğ / Ğ”ĞĞœ',       p:'Ğ’Ğ¸Ğ»Ğ»Ğ° 54  Ğ¸Ğ»Ğ¸  Mimosa Cluster, Villa 63',req:true},
      {k:'street',  l:'Ğ£Ğ›Ğ˜Ğ¦Ğ / ĞĞ Ğ˜Ğ•ĞĞ¢Ğ˜Ğ ',   p:'Jumeirah St, Ñ€ÑĞ´Ğ¾Ğ¼ Ñ Ğ¿Ğ°Ñ€ĞºĞ¾Ğ¼',            req:false},
    ]},
    {id:'apt',   icon:'ğŸ¢',lbl:'ĞšĞ²Ğ°Ñ€Ñ‚Ğ¸Ñ€Ğ°',fields:[
      {k:'complex', l:'Ğ–Ğš / Ğ—Ğ”ĞĞĞ˜Ğ•',        p:'Marina Heights',                         req:true},
      {k:'apt',     l:'ĞĞĞœĞ•Ğ  ĞšĞ’ĞĞ Ğ¢Ğ˜Ğ Ğ«',     p:'702',                                    req:true},
      {k:'floor',   l:'Ğ­Ğ¢ĞĞ–',              p:'7',                                      req:false},
      {k:'entrance',l:'ĞŸĞĞ”ĞªĞ•Ğ—Ğ” / Ğ’Ğ¥ĞĞ”',    p:'B',                                      req:false},
    ]},
    {id:'office',icon:'ğŸ’¼',lbl:'ĞÑ„Ğ¸Ñ',fields:[
      {k:'building',l:'Ğ‘Ğ¦ / Ğ—Ğ”ĞĞĞ˜Ğ•',        p:'DIFC Gate Building',                     req:true},
      {k:'floor',   l:'Ğ­Ğ¢ĞĞ–',              p:'12',                                     req:false},
      {k:'room',    l:'ĞĞ¤Ğ˜Ğ¡',              p:'305',                                    req:false},
    ]},
    {id:'other', icon:'ğŸ“Œ',lbl:'Ğ”Ñ€ÑƒĞ³Ğ¾Ğµ',fields:[
      {k:'details', l:'ĞĞŸĞ˜Ğ¡ĞĞĞ˜Ğ• / ĞĞ Ğ˜Ğ•ĞĞ¢Ğ˜Ğ ',p:'Ğ›ÑĞ±Ñ‹Ğµ Ğ´ĞµÑ‚Ğ°Ğ»Ğ¸...',                        req:true},
    ]},
  ],
  en:[
    {id:'home',  icon:'ğŸ ',lbl:'House / Villa',fields:[
      {k:'villa',   l:'VILLA / HOUSE',      p:'Villa 54  or  Mimosa Cluster, Villa 63', req:true},
      {k:'street',  l:'STREET / LANDMARK',  p:'Jumeirah St, near the park',             req:false},
    ]},
    {id:'apt',   icon:'ğŸ¢',lbl:'Apartment',fields:[
      {k:'complex', l:'BUILDING / COMPLEX', p:'Marina Heights',                         req:true},
      {k:'apt',     l:'APARTMENT NO.',      p:'702',                                    req:true},
      {k:'floor',   l:'FLOOR',             p:'7',                                      req:false},
      {k:'entrance',l:'ENTRANCE / GATE',   p:'B',                                      req:false},
    ]},
    {id:'office',icon:'ğŸ’¼',lbl:'Office',fields:[
      {k:'building',l:'BUILDING / TOWER',   p:'DIFC Gate Building',                     req:true},
      {k:'floor',   l:'FLOOR',             p:'12',                                     req:false},
      {k:'room',    l:'OFFICE / UNIT',     p:'305',                                    req:false},
    ]},
    {id:'other', icon:'ğŸ“Œ',lbl:'Other',fields:[
      {k:'details', l:'DESCRIPTION',        p:'Any details, landmarks...',              req:true},
    ]},
  ],
};

function hav(a,b,c,d){const R=6371,dl=(c-a)*Math.PI/180,dm=(d-b)*Math.PI/180,e=Math.sin(dl/2)**2+Math.cos(a*Math.PI/180)*Math.cos(c*Math.PI/180)*Math.sin(dm/2)**2;return R*2*Math.atan2(Math.sqrt(e),Math.sqrt(1-e));}
function nearestOffice(lat,lon){return OFFICES.reduce((b,o)=>{const d=hav(lat,lon,o.lat,o.lon);return(!b||d<b._d)?{...o,_d:d}:b;},null);}

// â”€â”€ CATALOG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let P=[];
async function loadCatalog(){
  try{
    const r=await fetch('https://nakhundov02.github.io/ambarwebpage/catalog.json?t='+Date.now());
    if(!r.ok)throw new Error('HTTP '+r.status);
    P=await r.json();
  }catch(e){console.warn('Catalog failed:',e);}
  buildChips();renderGrid();
}
const TIP_OPTS=[0,50,100,200,500];

// â”€â”€ TRANSLATIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const TX={
ru:{
  catalog:'ĞšĞ°Ñ‚Ğ°Ğ»Ğ¾Ğ³',cart:'ĞšĞ¾Ñ€Ğ·Ğ¸Ğ½Ğ°',addrPage:'ĞĞ´Ñ€ĞµÑĞ°',orders:'Ğ˜ÑÑ‚Ğ¾Ñ€Ğ¸Ñ',profile:'ĞŸÑ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ',
  all:'Ğ’ÑĞµ',total:'Ğ˜Ğ¢ĞĞ“Ğ',tip:'Ğ§ĞĞ•Ğ’Ğ«Ğ•',noTip:'Ğ‘ĞµĞ· Ñ‡Ğ°ĞµĞ²Ñ‹Ñ…',customTip:'âœï¸ Ğ¡Ğ²Ğ¾Ñ',
  coBtn:'ĞÑ„Ğ¾Ñ€Ğ¼Ğ¸Ñ‚ÑŒ Ğ·Ğ°ĞºĞ°Ğ· â†’',clearCart:'ğŸ—‘ ĞÑ‡Ğ¸ÑÑ‚Ğ¸Ñ‚ÑŒ ĞºĞ¾Ñ€Ğ·Ğ¸Ğ½Ñƒ',
  addrPill:'Ğ”Ğ¾Ğ±Ğ°Ğ²ÑŒÑ‚Ğµ Ğ°Ğ´Ñ€ĞµÑ Ğ´Ğ¾ÑÑ‚Ğ°Ğ²ĞºĞ¸',addrPillChange:'Ğ˜Ğ·Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ',
  modalTitle:'ĞĞ´Ñ€ĞµÑ Ğ´Ğ¾ÑÑ‚Ğ°Ğ²ĞºĞ¸',modalAdd:'Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ Ğ°Ğ´Ñ€ĞµÑ',
  cabLabel:'ĞĞ”Ğ Ğ•Ğ¡ Ğ”ĞĞ¡Ğ¢ĞĞ’ĞšĞ˜',cabNoAddr:'ĞĞµ Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½ â€” Ğ½Ğ°Ğ¶Ğ¼Ğ¸Ñ‚Ğµ Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ',cabChange:'Ğ˜Ğ·Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ',
  shSaved:'Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ñ‘Ğ½Ğ½Ñ‹Ğµ Ğ°Ğ´Ñ€ĞµÑĞ°',addFormTitle:'â• Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ°Ğ´Ñ€ĞµÑ',
  lblArea:'Ğ ĞĞ™ĞĞ / Ğ—ĞĞĞ',lblStreet:'Ğ£Ğ›Ğ˜Ğ¦Ğ / Ğ—Ğ”ĞĞĞ˜Ğ•',lblTypeGps:'Ğ¢Ğ˜ĞŸ ĞĞ”Ğ Ğ•Ğ¡Ğ',lblTypeMan:'Ğ¢Ğ˜ĞŸ ĞĞ”Ğ Ğ•Ğ¡Ğ',
  gpsBtn:'ğŸ“ ĞŸĞ¾Ğ´ĞµĞ»Ğ¸Ñ‚ÑŒÑÑ Ğ³ĞµĞ¾Ğ»Ğ¾ĞºĞ°Ñ†Ğ¸ĞµĞ¹',gpsBtnLoading:'â³ ĞĞ¿Ñ€ĞµĞ´ĞµĞ»ÑĞµĞ¼...',
  gpsOk:'âœ… Ğ“ĞµĞ¾Ğ»Ğ¾ĞºĞ°Ñ†Ğ¸Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ° â€” Ğ²Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ñ‚Ğ¸Ğ¿',gpsFail:'âš ï¸ ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ³ĞµĞ¾Ğ»Ğ¾ĞºĞ°Ñ†Ğ¸Ñ',
  lblAddrName:'ĞĞĞ—Ğ’ĞĞĞ˜Ğ• ĞĞ”Ğ Ğ•Ğ¡Ğ',saveAddrBtn:'ğŸ’¾ Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ Ğ°Ğ´Ñ€ĞµÑ',
  addrSaved:'ĞĞ´Ñ€ĞµÑ ÑĞ¾Ñ…Ñ€Ğ°Ğ½Ñ‘Ğ½ âœ“',addrDeleted:'ĞĞ´Ñ€ĞµÑ ÑƒĞ´Ğ°Ğ»Ñ‘Ğ½',addrSelected:'ĞĞ´Ñ€ĞµÑ Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½',
  nearOffice:'Ğ‘Ğ»Ğ¸Ğ¶Ğ°Ğ¹ÑˆĞ¸Ğ¹ Ğ¾Ñ„Ğ¸Ñ',
  addrFormErr:'âŒ Ğ—Ğ°Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚Ğµ Ğ¾Ğ±ÑĞ·Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğµ Ğ¿Ğ¾Ğ»Ñ',areaErr:'âŒ Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ñ€Ğ°Ğ¹Ğ¾Ğ½',
  noSaved:'ĞĞµÑ‚ ÑĞ¾Ñ…Ñ€Ğ°Ğ½Ñ‘Ğ½Ğ½Ñ‹Ñ… Ğ°Ğ´Ñ€ĞµÑĞ¾Ğ² â€” Ğ´Ğ¾Ğ±Ğ°Ğ²ÑŒÑ‚Ğµ Ğ¿ĞµÑ€Ğ²Ñ‹Ğ¹!',
  activeAddrLabel:'ĞĞšĞ¢Ğ˜Ğ’ĞĞ«Ğ™',
  ct2:'ĞĞ¾Ğ¼ĞµÑ€ Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½Ğ°',phoneLbl:'Ğ¢ĞĞ›Ğ¬ĞšĞ Ğ¦Ğ˜Ğ¤Ğ Ğ«, 10â€“15 Ğ—ĞĞĞšĞĞ’',phoneErr:'âŒ Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ ĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ½Ñ‹Ğ¹ Ğ½Ğ¾Ğ¼ĞµÑ€ (10â€“15 Ñ†Ğ¸Ñ„Ñ€)',
  sumTitle:'Ğ’Ğ°Ñˆ Ğ·Ğ°ĞºĞ°Ğ·',tipLbl:'Ğ§Ğ°ĞµĞ²Ñ‹Ğµ',totLbl:'Ğ˜Ñ‚Ğ¾Ğ³Ğ¾',placeBtn:'âœ… ĞŸĞ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ´Ğ¸Ñ‚ÑŒ Ğ·Ğ°ĞºĞ°Ğ·',
  coAddrTitle:'ĞĞ´Ñ€ĞµÑ Ğ´Ğ¾ÑÑ‚Ğ°Ğ²ĞºĞ¸',
  noOrders:'Ğ—Ğ°ĞºĞ°Ğ·Ğ¾Ğ² Ğ¿Ğ¾ĞºĞ° Ğ½ĞµÑ‚',noActive:'ĞĞµÑ‚ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ñ… Ğ·Ğ°ĞºĞ°Ğ·Ğ¾Ğ²',
  stP:'ğŸŸ¡ ĞĞ¶Ğ¸Ğ´Ğ°ĞµÑ‚',stC:'ğŸŸ¢ ĞŸÑ€Ğ¸Ğ½ÑÑ‚',stD:'âœ… Ğ”Ğ¾ÑÑ‚Ğ°Ğ²Ğ»ĞµĞ½',stX:'âŒ ĞÑ‚Ğ¼ĞµĞ½Ñ‘Ğ½',
  added:'Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¾',emptyCart:'ĞšĞ¾Ñ€Ğ·Ğ¸Ğ½Ğ° Ğ¿ÑƒÑÑ‚Ğ°',
  placed:'âœ… Ğ—Ğ°ĞºĞ°Ğ· Ğ¾Ñ„Ğ¾Ñ€Ğ¼Ğ»ĞµĞ½! ĞĞ¶Ğ¸Ğ´Ğ°Ğ¹Ñ‚Ğµ Ğ·Ğ²Ğ¾Ğ½ĞºĞ°.',
  activeOrders:'ĞĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ğµ Ğ·Ğ°ĞºĞ°Ğ·Ñ‹',oos:'ĞĞ•Ğ¢',
  statOrders:'Ğ—ĞĞšĞĞ—ĞĞ’',statActive:'ĞĞšĞ¢Ğ˜Ğ’ĞĞ«Ğ¥',statSpent:'ĞŸĞĞ¢Ğ ĞĞ§Ğ•ĞĞ',
  noAddrWarning:'Ğ¡Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ´Ğ¾Ğ±Ğ°Ğ²ÑŒÑ‚Ğµ Ğ°Ğ´Ñ€ĞµÑ Ğ´Ğ¾ÑÑ‚Ğ°Ğ²ĞºĞ¸',
  lcTitle:'Ğ’Ñ‹ Ñ‚Ğ°Ğ¼?',
  lcMsg:'ĞŸĞ¾Ñ…Ğ¾Ğ¶Ğµ, Ğ²Ñ‹ ÑĞµĞ¹Ñ‡Ğ°Ñ Ğ´Ğ°Ğ»ĞµĞºĞ¾ Ğ¾Ñ‚ Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ½Ğ¾Ğ³Ğ¾ Ğ°Ğ´Ñ€ĞµÑĞ°. Ğ’ÑÑ‘ Ñ€Ğ°Ğ²Ğ½Ğ¾ Ğ¾Ñ„Ğ¾Ñ€Ğ¼Ğ¸Ñ‚ÑŒ Ğ·Ğ°ĞºĞ°Ğ· Ñ‚ÑƒĞ´Ğ°?',
  lcYes:'Ğ”Ğ°, Ğ¾Ñ„Ğ¾Ñ€Ğ¼Ğ¸Ñ‚ÑŒ',lcNo:'ĞÑ‚Ğ¼ĞµĞ½Ğ°',
},
en:{
  catalog:'Catalog',cart:'Cart',addrPage:'Addresses',orders:'History',profile:'Profile',
  all:'All',total:'TOTAL',tip:'TIP',noTip:'No tip',customTip:'âœï¸ Custom',
  coBtn:'Checkout â†’',clearCart:'ğŸ—‘ Clear cart',
  addrPill:'Add delivery address',addrPillChange:'Change',
  modalTitle:'Delivery address',modalAdd:'Add new address',
  cabLabel:'DELIVERY ADDRESS',cabNoAddr:'Not set â€” tap to add',cabChange:'Change',
  shSaved:'Saved addresses',addFormTitle:'â• Add address',
  lblArea:'AREA / ZONE',lblStreet:'STREET / BUILDING',lblTypeGps:'ADDRESS TYPE',lblTypeMan:'ADDRESS TYPE',
  gpsBtn:'ğŸ“ Share my location',gpsBtnLoading:'â³ Getting location...',
  gpsOk:'âœ… Location received â€” select type',gpsFail:'âš ï¸ Could not get location',
  lblAddrName:'ADDRESS LABEL',saveAddrBtn:'ğŸ’¾ Save address',
  addrSaved:'Address saved âœ“',addrDeleted:'Address removed',addrSelected:'Address selected',
  nearOffice:'Nearest office',
  addrFormErr:'âŒ Fill in required fields',areaErr:'âŒ Select an area',
  noSaved:'No saved addresses â€” add your first one!',
  activeAddrLabel:'ACTIVE',
  ct2:'Phone Number',phoneLbl:'DIGITS ONLY, 10â€“15 DIGITS',phoneErr:'âŒ Enter a valid phone (10â€“15 digits)',
  sumTitle:'Your order',tipLbl:'Tip',totLbl:'Total',placeBtn:'âœ… Confirm order',
  coAddrTitle:'Delivery address',
  noOrders:'No orders yet',noActive:'No active orders',
  stP:'ğŸŸ¡ Pending',stC:'ğŸŸ¢ Confirmed',stD:'âœ… Delivered',stX:'âŒ Cancelled',
  added:'Added',emptyCart:'Cart is empty',
  placed:'âœ… Order placed! We\'ll call you.',
  activeOrders:'Active orders',oos:'N/A',
  statOrders:'ORDERS',statActive:'ACTIVE',statSpent:'SPENT AED',
  noAddrWarning:'Please add a delivery address first',
  lcTitle:'Are you there?',
  lcMsg:'It looks like you\'re not near the selected address. Order there anyway?',
  lcYes:'Yes, order',lcNo:'Cancel',
},
};

// â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let lang='ru',cart={},catF='all',tip=0;
let curMethod='gps',selTypeGps=null,selTypeMan=null,selArea=null;
let locInfo=null;    // GPS result {lat,lon,office_id,office_name}
let activeAddrIdx=null; // index into getSaved() â€” the selected delivery address
let orders=JSON.parse(localStorage.getItem('ambar_orders')||'[]');
let curPg='catalog';
let pendingOrderConfirmed=false; // for location mismatch flow
const tg=window.Telegram?.WebApp||null;

// â”€â”€ BOOT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.addEventListener('DOMContentLoaded',()=>{
  if(tg){tg.ready();tg.expand();tg.setHeaderColor&&tg.setHeaderColor('#07070E');tg.setBackgroundColor&&tg.setBackgroundColor('#07070E');}
  // Restore active address index
  const saved=localStorage.getItem('ambar_active_addr');
  if(saved!==null) activeAddrIdx=parseInt(saved);
  // Validate it still exists
  if(activeAddrIdx!==null&&!getSaved()[activeAddrIdx]) activeAddrIdx=null;
  buildTips();renderOrders();applyLang();loadCatalog();
  updateAddrPill();updateCartAddrBar();
});

// â”€â”€ HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function t(k){return TX[lang][k]||TX.ru[k]||k;}
function el(id){return document.getElementById(id);}
function set(id,v){const e=el(id);if(e)e.textContent=v;}

// â”€â”€ LANGUAGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function flipLang(){
  lang=lang==='ru'?'en':'ru';
  applyLang();buildChips();renderGrid();buildTips();renderOrders();renderCart();buildSummary();buildProfile();
  buildTypeChips('gps');buildTypeChips('man');buildAreaChips();renderSavedCards();updateAddrPill();updateCartAddrBar();
}
function applyLang(){
  const f=lang==='ru'?'ğŸ‡·ğŸ‡º':'ğŸ‡¬ğŸ‡§';
  document.querySelectorAll('.lang-btn').forEach(b=>b.textContent=f);
  set('sh-catalog',t('catalog'));set('ls-cart',t('cart'));set('ls-addr',t('addrPage'));
  set('ls-ord',t('orders'));set('ls-prof',t('profile'));
  set('sh-orders',t('orders'));set('sh-active',t('activeOrders'));
  set('nbl-cat',t('catalog'));set('nbl-cart',t('cart'));set('nbl-addr',t('addrPage'));
  set('nbl-ord',t('orders'));set('nbl-prof',t('profile'));
  set('tot-lbl',t('total'));set('co-btn',t('coBtn'));set('clear-btn',t('clearCart'));
  set('modal-title',t('modalTitle'));set('modal-add-lbl',t('modalAdd'));
  set('sh-saved-addr',t('shSaved'));set('add-form-title',t('addFormTitle'));
  set('lbl-area',t('lblArea'));set('lbl-street',t('lblStreet'));
  set('gps-lbl',t('gpsBtn'));
  set('lbl-addr-name',t('lblAddrName'));set('save-addr-btn',t('saveAddrBtn'));
  set('cab-label',t('cabLabel'));set('cab-change',t('cabChange'));
  set('ct2',t('ct2'));set('phone-lbl',t('phoneLbl'));
  el('phone-in').placeholder=lang==='ru'?'79001234567':'971501234567';
  el('man-street').placeholder=lang==='ru'?'JVC Bloom Tower / Jumeirah St':'JVC Bloom Tower / Jumeirah St';
  el('addr-name-in').placeholder=lang==='ru'?'Ğ”Ğ¾Ğ¼ / ĞÑ„Ğ¸Ñ / JVC...':'Home / Office / JVC...';
  set('lbl-addr-comment',lang==='ru'?'ĞšĞĞœĞœĞ•ĞĞ¢ĞĞ Ğ˜Ğ™ Ğ”Ğ›Ğ¯ ĞšĞ£Ğ Ğ¬Ğ•Ğ Ğ':'COMMENT FOR COURIER');
  el('addr-comment-in').placeholder=lang==='ru'?'Ğ”Ğ¾Ğ¼Ğ¾Ñ„Ğ¾Ğ½ 47, 3 ÑÑ‚Ğ°Ğ¶, ĞºĞ²Ğ°Ñ€Ñ‚Ğ¸Ñ€Ğ° ÑĞ¿Ñ€Ğ°Ğ²Ğ°...':'Intercom 47, 3rd floor, apt on the right...';
  set('sum-title',t('sumTitle'));set('sum-tip-lbl',t('tipLbl'));set('sum-tot-lbl',t('totLbl'));
  set('place-btn',t('placeBtn'));set('tip-lbl',t('tip'));set('co-addr-title',t('coAddrTitle'));
  el('tip-input').placeholder=lang==='ru'?'Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ ÑÑƒĞ¼Ğ¼Ñƒ...':'Enter amount...';
  set('mtl-gps','GPS');set('mtl-manual',lang==='ru'?'Ğ’Ñ€ÑƒÑ‡Ğ½ÑƒÑ':'Manual');
  set('lc-title',t('lcTitle'));set('lc-msg',t('lcMsg'));set('lc-yes',t('lcYes'));set('lc-no',t('lcNo'));
}

// â”€â”€ PAGES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const PAGES=['catalog','cart','address','orders','profile','checkout'];
function go(p){
  PAGES.forEach(id=>{
    el('pg-'+id)?.classList.toggle('hidden',id!==p);
    el('nb-'+id)?.classList.toggle('on',id===p);
  });
  curPg=p;
  if(p==='cart'){renderCart();updateCartAddrBar();}
  if(p==='orders')renderOrders();
  if(p==='address'){renderSavedCards();buildTypeChips('gps');buildAreaChips();buildTypeChips('man');}
  if(p==='profile')buildProfile();
  if(p==='checkout')buildSummary();
}

// â”€â”€ SAVED ADDRESSES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getSaved(){return JSON.parse(localStorage.getItem('ambar_saved')||'[]');}
function setSaved(a){localStorage.setItem('ambar_saved',JSON.stringify(a.slice(0,10)));}
function setActiveAddr(idx){
  activeAddrIdx=idx;
  if(idx===null)localStorage.removeItem('ambar_active_addr');
  else localStorage.setItem('ambar_active_addr',String(idx));
  updateAddrPill();updateCartAddrBar();
}

function updateAddrPill(){
  const arr=getSaved();
  const dot=el('addr-pill-dot'),txt=el('addr-pill-txt');
  if(!dot||!txt)return;
  if(activeAddrIdx!==null&&arr[activeAddrIdx]){
    const a=arr[activeAddrIdx];
    dot.style.background='var(--green)';
    txt.textContent=a.label||a.address;
  } else {
    dot.style.background='var(--muted)';
    txt.textContent=t('addrPill');
  }
}

function updateCartAddrBar(){
  const arr=getSaved();
  const cab=el('cab-addr');if(!cab)return;
  if(activeAddrIdx!==null&&arr[activeAddrIdx]){
    const a=arr[activeAddrIdx];
    cab.textContent=a.label?a.label+' â€” '+a.address:a.address;
    cab.style.color='var(--text)';
  } else {
    cab.textContent=t('cabNoAddr');
    cab.style.color='var(--muted)';
  }
}

function renderSavedCards(){
  const arr=getSaved();
  const wrap=el('saved-cards');if(!wrap)return;
  if(!arr.length){
    wrap.innerHTML=`<div class="empty" style="padding:24px 0"><div class="empty-icon">ğŸ“</div><div>${t('noSaved')}</div></div>`;
    return;
  }
  wrap.innerHTML=arr.map((a,i)=>{
    const isActive=i===activeAddrIdx;
    const typeIcon=a.typeIcon||'ğŸ“';
    return`<div class="saved-card${isActive?' active-addr':''}">
      ${isActive?`<div class="active-badge">${t('activeAddrLabel')}</div>`:''}
      <span class="sc-icon">${typeIcon}</span>
      <div class="sc-info">
        <div class="sc-label">${a.label||a.address}</div>
        <div class="sc-addr">${a.label&&a.label!==a.address?a.address:''}</div>
        <div class="sc-office">ğŸ¢ ${a.office_name||''}</div>
      </div>
      <div class="sc-actions">
        <button class="sc-btn sel" onclick="selectAddr(${i})" title="Ğ’Ñ‹Ğ±Ñ€Ğ°Ñ‚ÑŒ">âœ“</button>
        <button class="sc-btn del" onclick="deleteAddr(${i})" title="Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ">âœ•</button>
      </div>
    </div>`;
  }).join('');
}

function selectAddr(i){
  setActiveAddr(i);
  renderSavedCards();
  closeAddrModal();
  showToast(t('addrSelected')+': '+(getSaved()[i]?.label||''),'ok');
}

function deleteAddr(i){
  const arr=getSaved();arr.splice(i,1);setSaved(arr);
  // Adjust active index
  if(activeAddrIdx===i) setActiveAddr(arr.length?0:null);
  else if(activeAddrIdx!==null&&activeAddrIdx>i) setActiveAddr(activeAddrIdx-1);
  renderSavedCards();renderModalAddrList();
  showToast(t('addrDeleted'),'ok');
}

// â”€â”€ ADDRESS MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openAddrModal(){
  renderModalAddrList();
  el('addr-modal').classList.add('show');
}
function closeAddrModal(e){
  if(e&&e.target!==el('addr-modal'))return;
  el('addr-modal').classList.remove('show');
}
function renderModalAddrList(){
  const arr=getSaved();
  const list=el('modal-addr-list');if(!list)return;
  if(!arr.length){
    list.innerHTML=`<div style="padding:20px 16px;font-size:13px;color:var(--muted)">${t('noSaved')}</div>`;return;
  }
  list.innerHTML=arr.map((a,i)=>`
    <div class="modal-addr-item${i===activeAddrIdx?' active':''}" onclick="selectAddr(${i})">
      <span class="mai-icon">${a.typeIcon||'ğŸ“'}</span>
      <div class="mai-info">
        <div class="mai-label">${a.label||a.address}</div>
        <div class="mai-addr">${a.label&&a.label!==a.address?a.address:a.office_name||''}</div>
      </div>
      ${i===activeAddrIdx?'<span class="mai-check">âœ“</span>':''}
    </div>
  `).join('');
}

// â”€â”€ METHOD TABS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function switchMethod(m){
  curMethod=m;
  ['gps','manual'].forEach(id=>{
    el('mtab-'+id)?.classList.toggle('on',id===m);
    el('mpanel-'+id)?.classList.toggle('show',id===m);
  });
  if(m==='manual'){buildAreaChips();buildTypeChips('man');}
  if(m==='gps'){buildTypeChips('gps');}
  const ae=el('addr-form-err');if(ae){ae.classList.remove('on');ae.textContent='';}
}

// â”€â”€ AREA CHIPS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildAreaChips(){
  const ac=el('area-chips');if(!ac)return;
  ac.innerHTML=AREAS[lang].map((a,i)=>`
    <button class="type-chip${selArea===i?' on':''}" onclick="pickArea(${i})">${a.lbl}</button>
  `).join('');
}
function pickArea(i){
  selArea=i;buildAreaChips();
  const area=AREAS[lang][i];
  const off=OFFICES.find(o=>o.id===area.office)||OFFICES[0];
  locInfo={lat:0,lon:0,office_id:off.id,office_name:off.name};
  showPill(off.name);
}

// â”€â”€ TYPE CHIPS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildTypeChips(p){
  const types=TYPES[lang];
  const sel=p==='gps'?selTypeGps:selTypeMan;
  const chipsEl=el('tchips-'+p),fieldsEl=el('tfields-'+p);
  if(!chipsEl||!fieldsEl)return;
  chipsEl.innerHTML=types.map(tp=>`
    <button class="type-chip${tp.id===sel?' on':''}" onclick="pickType('${p}','${tp.id}')">${tp.icon} ${tp.lbl}</button>
  `).join('');
  if(sel){const tp=types.find(x=>x.id===sel);if(tp)renderFields(p,tp);}
  else fieldsEl.innerHTML='';
}
function pickType(p,id){
  if(p==='gps')selTypeGps=id;else selTypeMan=id;
  buildTypeChips(p);
}
function renderFields(p,tp){
  const el_=el('tfields-'+p);if(!el_)return;
  let html='';
  for(let i=0;i<tp.fields.length;i+=2){
    const a=tp.fields[i],b=tp.fields[i+1];
    const optA=!a.req?` <span style="color:var(--muted);font-size:8px">(${lang==='ru'?'Ğ½ĞµĞ¾Ğ±ÑĞ·.':'opt.'})</span>`:'';
    const optB=b&&!b.req?` <span style="color:var(--muted);font-size:8px">(${lang==='ru'?'Ğ½ĞµĞ¾Ğ±ÑĞ·.':'opt.'})</span>`:'';
    html+=`<div class="frow">
      <div><label class="flabel">${a.l}${optA}</label><input class="finput" id="f-${p}-${a.k}" type="text" placeholder="${a.p}"></div>
      ${b?`<div><label class="flabel">${b.l}${optB}</label><input class="finput" id="f-${p}-${b.k}" type="text" placeholder="${b.p}"></div>`:''}
    </div>`;
  }
  el_.innerHTML=html;
}

// â”€â”€ GPS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function grabGPS(){
  const btn=el('gps-btn'),stat=el('gps-status');
  btn.style.opacity='0.6';set('gps-lbl',t('gpsBtnLoading'));stat.className='gps-status';
  if(!navigator.geolocation){fail();return;}
  navigator.geolocation.getCurrentPosition(pos=>{
    const{latitude:lat,longitude:lon}=pos.coords;
    const off=nearestOffice(lat,lon);
    locInfo={lat,lon,office_id:off.id,office_name:off.name};
    btn.style.opacity='1';set('gps-lbl',t('gpsBtn'));
    stat.className='gps-status ok';stat.textContent=t('gpsOk');
    
    buildTypeChips('gps');showPill(off.name);
  },()=>fail(),{timeout:10000,maximumAge:60000,enableHighAccuracy:true});
  function fail(){btn.style.opacity='1';set('gps-lbl',t('gpsBtn'));stat.className='gps-status fail';stat.textContent=t('gpsFail');}
}

function showPill(name){
  const p=el('opill');if(!p)return;
  p.textContent='ğŸ¢ '+t('nearOffice')+': '+name;p.className='opill on';
}

// â”€â”€ BUILD ADDRESS STRING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildAddrStr(p){
  const types=TYPES[lang];
  const sel=p==='gps'?selTypeGps:selTypeMan;
  if(!sel)return null;
  const tp=types.find(x=>x.id===sel);if(!tp)return null;
  // Check required
  const missing=tp.fields.filter(f=>f.req&&!(el('f-'+p+'-'+f.k)?.value||'').trim());
  if(missing.length)return null;
  const parts=[];
  if(p==='manual'){
    if(selArea!==null){const area=AREAS[lang][selArea];if(area)parts.push(area.lbl);}
    const s=(el('man-street')?.value||'').trim();if(s)parts.push(s);
  }
  tp.fields.forEach(f=>{const v=(el('f-'+p+'-'+f.k)?.value||'').trim();if(v)parts.push(f.l+': '+v);});
  if(!parts.length)return null;
  return tp.icon+' '+tp.lbl+' â€” '+parts.join(' | ');
}

// â”€â”€ SAVE NEW ADDRESS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function saveNewAddress(){
  const ae=el('addr-form-err');ae.classList.remove('on');ae.textContent='';

  // Validate method
  if(curMethod==='manual'&&selArea===null){
    ae.textContent=t('areaErr');ae.classList.add('on');return;
  }
  if(curMethod==='gps'&&!locInfo){
    ae.textContent=t('gpsFail');ae.classList.add('on');return;
  }

  const addrStr=buildAddrStr(curMethod==='gps'?'gps':'man');
  if(!addrStr){ae.textContent=t('addrFormErr');ae.classList.add('on');return;}

  const label=(el('addr-name-in')?.value||'').trim();
  const types=TYPES[lang];
  const sel=curMethod==='gps'?selTypeGps:selTypeMan;
  const tp=types.find(x=>x.id===sel);

  const comment=(el('addr-comment-in')?.value||'').trim();
  const newAddr={
    label:label||tp?.lbl||addrStr,
    address:addrStr,
    typeIcon:tp?.icon||'ğŸ“',
    lat:locInfo?.lat||0,
    lon:locInfo?.lon||0,
    office_id:locInfo?.office_id||'office_central',
    office_name:locInfo?.office_name||OFFICES[0].name,
    comment:comment,
  };

  const arr=getSaved();
  arr.unshift(newAddr);
  setSaved(arr);

  // Auto-select if first address
  if(arr.length===1) setActiveAddr(0);
  else setActiveAddr(0); // always select the newly added one (it's at index 0)

  // Reset form
  resetAddrForm();
  renderSavedCards();
  showToast(t('addrSaved'),'ok');
}

function resetAddrForm(){
  curMethod='gps';selTypeGps=null;selTypeMan=null;selArea=null;locInfo=null;
  el('gps-status').className='gps-status';
  if(el('gps-extra')) el('gps-extra').style.display='none';
  el('opill').className='opill';
  el('addr-name-in').value='';el('addr-comment-in').value='';
  el('man-street').value='';
  if(el('tfields-gps')) el('tfields-gps').innerHTML='';if(el('tfields-man')) el('tfields-man').innerHTML='';
  el('addr-form-err').classList.remove('on');el('addr-form-err').textContent='';
  set('gps-lbl',t('gpsBtn'));
  switchMethod('gps');buildTypeChips('gps');buildAreaChips();buildTypeChips('man');
}

// â”€â”€ CATALOG CHIPS & GRID â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildChips(){
  const cats=['all',...new Set(P.map(p=>lang==='ru'?p.cat:p.catE))];
  el('cat-chips').innerHTML=cats.map(c=>`<button class="chip${c===catF?' on':''}" onclick="setCat('${c}',this)">${c==='all'?t('all'):c}</button>`).join('');
}
function setCat(c,btn){catF=c;document.querySelectorAll('.chip').forEach(b=>b.classList.remove('on'));btn.classList.add('on');renderGrid();}
function renderGrid(){
  const list=catF==='all'?P:P.filter(p=>(lang==='ru'?p.cat:p.catE)===catF);
  el('p-grid').innerHTML=list.map(p=>{
    const qty=cart[p.id]||0;
    return`<div class="pcard">
      <div class="pimg-box">
        ${!p.stock?`<span class="pbadge oos">${t('oos')}</span>`:''}
        ${p.isNew?`<span class="pbadge isnew">NEW</span>`:''}
        <img class="pimg" src="${p.img}" alt="${p.name}" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 80 80%22><text y=%2268%22 font-size=%2264%22>ğŸ¾</text></svg>'">
      </div>
      <div class="pinfo">
        <div class="pcat">${lang==='ru'?p.cat:p.catE}</div>
        <div class="pname">${p.name}</div>
        <div class="pdesc">${lang==='ru'?p.dRu:p.dEn}</div>
        <div class="pfoot"><div class="pprice">${p.price}<small> AED</small></div><div id="ctrl-${p.id}">${ctrlHTML(p,qty)}</div></div>
      </div>
    </div>`;
  }).join('');
}
function ctrlHTML(p,qty){
  if(qty===0)return`<button class="add-btn"${!p.stock?' disabled':''} onclick="addItem('${p.id}')">+</button>`;
  return`<div class="qctrl"><button class="qb" onclick="chgQty('${p.id}',-1)">âˆ’</button><span class="qn">${qty}</span><button class="qb" onclick="chgQty('${p.id}',1)">+</button></div>`;
}
function addItem(id){
  const p=P.find(x=>x.id===id);if(!p||!p.stock)return;
  const max=p.stockQty||999;
  if((cart[id]||0)>=max){showToast(lang==='ru'?`Ğ”Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾: ${max}`:`Only ${max} available`,'err');return;}
  cart[id]=1;syncCtrl(id);updHdr();showToast(t('added')+': '+p.name,'ok');
}
function chgQty(id,d){
  const p=P.find(x=>x.id===id),max=p?(p.stockQty||999):999,nq=(cart[id]||0)+d;
  if(d>0&&nq>max){showToast(lang==='ru'?`Ğ”Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾: ${max}`:`Only ${max} available`,'err');return;}
  if(nq<=0)delete cart[id];else cart[id]=nq;
  syncCtrl(id);updHdr();if(curPg==='cart')renderCart();
}
function syncCtrl(id){const e=el('ctrl-'+id);if(!e)return;const p=P.find(x=>x.id===id);e.innerHTML=ctrlHTML(p,cart[id]||0);}
function cartSub(){return Object.entries(cart).reduce((s,[id,qty])=>{const p=P.find(x=>x.id===id);return s+(p?p.price*qty:0);},0);}
function updHdr(){
  const cnt=Object.values(cart).reduce((a,b)=>a+b,0);
  el('hdr-tot').textContent=cartSub()+' AED';
  const dot=el('hdr-dot');dot.textContent=cnt;dot.style.display=cnt>0?'flex':'none';
}

// â”€â”€ CART â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderCart(){
  const entries=Object.entries(cart).filter(([,q])=>q>0);
  const foot=el('cart-foot'),tipSec=el('tip-section');
  if(!entries.length){
    el('cart-list').innerHTML=`<div class="empty"><div class="empty-icon">ğŸ›’</div><div>${t('emptyCart')}</div></div>`;
    foot.style.display='none';tipSec.style.display='none';return;
  }
  el('cart-list').innerHTML=entries.map(([id,qty])=>{
    const p=P.find(x=>x.id===id);if(!p)return'';
    return`<div class="ci"><img class="ci-img" src="${p.img}" alt="${p.name}" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 52 62%22><text y=%2248%22 font-size=%2240%22>ğŸ¾</text></svg>'">
      <div class="ci-info"><div class="ci-name">${p.name}</div><div class="ci-price">${p.price*qty} AED</div></div>
      <div class="qctrl"><button class="qb" onclick="chgQty('${id}',-1)">âˆ’</button><span class="qn">${qty}</span><button class="qb" onclick="chgQty('${id}',1)">+</button></div>
    </div>`;
  }).join('');
  el('tot-n').textContent=cartSub()+tip;foot.style.display='block';tipSec.style.display='block';
}
function clearCart(){cart={};tip=0;updHdr();renderCart();buildTips();}

// â”€â”€ TIPS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildTips(){
  el('tip-row').innerHTML=TIP_OPTS.map((v,i)=>{
    const isLast=i===TIP_OPTS.length-1,lbl=isLast?t('customTip'):(v===0?t('noTip'):`${v} AED`);
    return`<button class="tip-chip${v===tip&&!isLast?' on':''}" onclick="pickTip(${v},${isLast},this)">${lbl}</button>`;
  }).join('');
  el('tip-input').placeholder=lang==='ru'?'Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ ÑÑƒĞ¼Ğ¼Ñƒ...':'Enter amount...';
}
function pickTip(v,isCustom,btn){
  document.querySelectorAll('.tip-chip').forEach(b=>b.classList.remove('on'));btn.classList.add('on');
  const inp=el('tip-input');
  if(isCustom){inp.style.display='block';inp.focus();inp.oninput=()=>{tip=Math.max(0,parseInt(inp.value)||0);updCartTot()};}
  else{inp.style.display='none';tip=v;updCartTot();}
}
function updCartTot(){el('tot-n').textContent=cartSub()+tip;buildSummary();}

// â”€â”€ SUMMARY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildSummary(){
  const entries=Object.entries(cart).filter(([,q])=>q>0),sub=cartSub();
  el('sum-items').innerHTML=entries.map(([id,qty])=>{const p=P.find(x=>x.id===id);return p?`<div class="sum-line"><span>${p.name} Ã—${qty}</span><span>${p.price*qty} AED</span></div>`:''}).join('');
  const tr=el('sum-tip-row');
  if(tip>0){tr.style.display='flex';el('sum-tip-val').textContent=tip+' AED';}else tr.style.display='none';
  el('sum-tot-val').textContent=(sub+tip)+' AED';
}

// â”€â”€ ORDER FLOW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function tryOrder(){
  const entries=Object.entries(cart).filter(([,q])=>q>0);
  if(!entries.length){showToast(t('emptyCart'),'err');return;}

  // No address â†’ send to address page
  if(activeAddrIdx===null||!getSaved()[activeAddrIdx]){
    showToast(t('noAddrWarning'),'err');
    setTimeout(()=>go('address'),600);return;
  }

  // Check location mismatch
  const addr=getSaved()[activeAddrIdx];
  if(addr.lat&&addr.lon&&navigator.geolocation&&!pendingOrderConfirmed){
    navigator.geolocation.getCurrentPosition(pos=>{
      const dist=hav(pos.coords.latitude,pos.coords.longitude,addr.lat,addr.lon);
      if(dist>15){ // more than 15km away â†’ warn
        showLocConfirm();
      } else {
        proceedToCheckout();
      }
    },()=>{proceedToCheckout();},{timeout:5000,maximumAge:120000});
  } else {
    proceedToCheckout();
  }
}

function showLocConfirm(){
  el('loc-confirm').classList.add('show');
}
function confirmLocYes(){
  el('loc-confirm').classList.remove('show');
  pendingOrderConfirmed=true;
  proceedToCheckout();
}
function confirmLocNo(){
  el('loc-confirm').classList.remove('show');
}

function proceedToCheckout(){
  pendingOrderConfirmed=false;
  // Show address preview in checkout
  const addr=getSaved()[activeAddrIdx];
  el('co-addr-preview').innerHTML=`<strong>${addr.label||''}</strong>${addr.label?'<br>':''}${addr.address}<br><span style="color:var(--gold);font-size:11px">ğŸ¢ ${addr.office_name}</span>`;
  buildSummary();
  go('checkout');
}

function placeOrder(){
  const entries=Object.entries(cart).filter(([,q])=>q>0);
  if(!entries.length){showToast(t('emptyCart'),'err');return;}

  const addr=getSaved()[activeAddrIdx];
  if(!addr){showToast(t('noAddrWarning'),'err');return;}

  const raw=el('phone-in').value.trim(),digits=raw.replace(/\D/g,'');
  if(digits.length<10||digits.length>15){
    el('phone-in').classList.add('err');el('phone-err').textContent=t('phoneErr');el('phone-err').classList.add('on');
    el('phone-in').focus();return;
  }

  const items=entries.map(([id,qty])=>{const p=P.find(x=>x.id===id);return{id,name:p.name,price:p.price,qty,line_total:p.price*qty};});
  const sub=cartSub(),total=sub+tip,oid='AMB'+Date.now().toString().slice(-7);
  const payload={
    action:'order',order_id:oid,items,subtotal:sub,tip,total,currency:'AED',
    phone:digits,address:addr.address,address_label:addr.label,comment:addr.comment||'',
    location:{lat:addr.lat||0,lon:addr.lon||0},
    office_id:addr.office_id||'office_central',
    office_name:addr.office_name||OFFICES[0].name,lang,
  };

  orders.unshift({order_id:oid,items,total,address:addr.label||addr.address,status:'pending',timestamp:new Date().toISOString()});
  localStorage.setItem('ambar_orders',JSON.stringify(orders.slice(0,50)));

  if(tg?.sendData)tg.sendData(JSON.stringify(payload));
  else console.log('ORDER:',JSON.stringify(payload,null,2));

  cart={};tip=0;el('phone-in').value='';el('phone-err').classList.remove('on');el('phone-in').classList.remove('err');
  updHdr();buildTips();showToast(t('placed'),'ok');
  setTimeout(()=>go('orders'),1400);
}

// â”€â”€ ORDERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderOrders(){
  if(!orders.length){el('orders-list').innerHTML=`<div class="empty"><div class="empty-icon">ğŸ“¦</div><div>${t('noOrders')}</div></div>`;return;}
  const cls={pending:'sp',confirmed:'sc2',delivered:'sd',declined:'sx'};
  const lbl={pending:()=>t('stP'),confirmed:()=>t('stC'),delivered:()=>t('stD'),declined:()=>t('stX')};
  el('orders-list').innerHTML=orders.map(o=>{
    const ts=o.timestamp?o.timestamp.slice(0,16).replace('T',' '):'';
    return`<div class="ocard"><div class="ocard-top"><div><div class="o-id">#${o.order_id}</div><div class="o-date">${ts}</div></div><span class="o-status ${cls[o.status]||'sp'}">${(lbl[o.status]||lbl.pending)()}</span></div><div class="o-items">${o.items.map(i=>`${i.name} Ã—${i.qty}`).join(' Â· ')}</div><div class="o-total">${o.total} AED</div></div>`;
  }).join('');
}

// â”€â”€ PROFILE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildProfile(){
  const name=tg?.initDataUnsafe?.user?.first_name||'Guest';
  el('prof-av').textContent=name[0]?.toUpperCase()||'A';el('prof-name').textContent=name;
  const active=orders.filter(o=>['pending','confirmed'].includes(o.status));
  const spent=orders.filter(o=>o.status==='delivered').reduce((s,o)=>s+o.total,0);
  el('stat-total').textContent=orders.length;el('stat-active').textContent=active.length;el('stat-spent').textContent=spent;
  set('stat-lbl1',t('statOrders'));set('stat-lbl2',t('statActive'));set('stat-lbl3',t('statSpent'));
  if(!active.length){el('active-list').innerHTML=`<div class="empty" style="padding:20px 0"><div>${t('noActive')}</div></div>`;return;}
  el('active-list').innerHTML=active.map(o=>`<div class="ocard"><div class="ocard-top"><div><div class="o-id">#${o.order_id}</div></div><span class="o-status ${o.status==='confirmed'?'sc2':'sp'}">${o.status==='confirmed'?t('stC'):t('stP')}</span></div><div class="o-items">${o.items.map(i=>`${i.name} Ã—${i.qty}`).join(' Â· ')}</div><div class="o-total">${o.total} AED</div></div>`).join('');
}

// â”€â”€ TOAST (two-element ping-pong, never sticks) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _tt,_ti=0;
function showToast(msg,type=''){
  clearTimeout(_tt);
  _ti=1-_ti;
  const cur=el('toast'+_ti),other=el('toast'+(1-_ti));
  if(other)other.className='toast';
  if(!cur)return;
  cur.className='toast';
  cur.textContent=msg;
  setTimeout(()=>{cur.className='toast'+(type?' '+type:'')+' show';},16);
  _tt=setTimeout(()=>cur.classList.remove('show'),2800);
}
</script>
</body>
</html>
